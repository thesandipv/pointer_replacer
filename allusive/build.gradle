/*
 * Copyright (C) 2016-2020 Sandip Vaghela
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
plugins {
    id 'com.android.application'
    id 'kotlin-android'
    id 'kotlin-parcelize'
    id 'kotlin-kapt'
    id 'com.google.gms.google-services'
    id 'com.google.firebase.crashlytics'
    id 'com.google.android.gms.oss-licenses-plugin'
    id 'dagger.hilt.android.plugin'
    id 'androidx.navigation.safeargs.kotlin'
}

kapt {
    correctErrorTypes = true
    useBuildCache = true
}

apply from: "$rootDir/gradle/oss-licence.gradle"
apply from: "$rootDir/gradle/apply-core.gradle"

hilt {
    enableAggregatingTask = true
}

ext {
    ci = System.getenv("CI") == "true"
}

android {
    compileSdkVersion SDK.COMPILE

    buildFeatures {
        viewBinding true
        dataBinding true
    }

    defaultConfig {
        applicationId "com.afterroot.allusive2"
        minSdkVersion SDK.MIN
        targetSdkVersion SDK.TARGET
        versionCode VERSION_CODE
        versionName VERSION_NAME
        vectorDrawables {
            useSupportLibrary = true
        }
        multiDexEnabled true

        manifestPlaceholders = [
                hostName  : "afterroot.web.app",
                pathPrefix: "/apps/pointer-replacer/launch"
        ]

        resConfigs "en"

        def commitHash = new ByteArrayOutputStream()
        exec {
            commandLine 'git', 'rev-parse', '--short', 'HEAD'
            standardOutput = commitHash
        }

        def commit = System.getenv("COMMIT_ID") ?: commitHash.toString().trim()
        buildConfigField "String", "COMMIT_ID", "\"$commit\""
    }

    def keystorePropertiesFile = rootProject.file("keystore.properties")
    def keystoreProperties = new Properties()
    if (keystorePropertiesFile.exists()) {
        keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
    }

    signingConfigs {
        allusive {
            keyAlias "allusive"
            keyPassword keystoreProperties['keyPassword'] ?: System.getenv("SIGN_KEY_PW")
            storeFile rootProject.file("release/keystore.jks")
            storePassword keystoreProperties['storePassword'] ?: System.getenv("SIGN_STORE_PW")
        }
    }

    buildTypes {
        release {
            shrinkResources true
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            multiDexKeepProguard file('proguard-rules.pro')
            multiDexKeepFile file('main_dex.txt')
            signingConfig signingConfigs.allusive
        }
        debug {
            ext.alwaysUpdateBuildId = false
            splits.abi.enable = false
            splits.density.enable = false
            crunchPngs false

            signingConfig signingConfigs.allusive

            versionNameSuffix = '-beta'
        }
    }

    lintOptions {
        abortOnError false
    }

    packagingOptions {
        // Exclude AndroidX version files
        exclude 'META-INF/*.version'
        // Exclude consumer proguard files
        exclude 'META-INF/proguard/*'
        // Exclude the Firebase/Fabric/other random properties files
        exclude '/*.properties'
        exclude 'fabric/*.properties'
        exclude 'META-INF/*.properties'
        exclude "DebugProbesKt.bin" //Exclude coroutines debug file
        exclude 'META-INF/DEPENDENCIES'
    }

    sourceSets {
        // Adds exported schema location as test app assets.
        androidTest.assets.srcDirs += files("$projectDir/schemas".toString())
    }

    compileOptions {
        sourceCompatibility = 1.8
        targetCompatibility = 1.8
    }

    lintOptions {
        abortOnError false
    }
}

configurations {
    all {
        exclude group: 'org.apache.httpcomponents'
    }
}

dependencies {
    implementation project(":base")
    implementation project(":data")
    implementation project(":ui:magisk")
    implementation project(":ui:repo")
    implementation project(":ui:resources")

    implementation libs.kotlin.stdLib

    implementation libs.androidx.appCompat
    implementation libs.androidx.billing
    implementation libs.androidx.cardView
    implementation libs.androidx.constraintLayout
    implementation libs.androidx.fragment
    implementation libs.bundles.lifecycle
    implementation libs.androidx.multiDex
    implementation libs.androidx.navigation.fragment
    implementation libs.androidx.navigation.ui
    implementation libs.androidx.paging
    implementation libs.androidx.palette
    implementation libs.androidx.preference
    implementation libs.androidx.recyclerView
    implementation libs.androidx.supportV13
    implementation libs.androidx.supportV4
    implementation libs.androidx.vectorDrawable
    implementation libs.androidx.work

    implementation libs.androidx.room.room
    implementation libs.androidx.room.runtime
    kapt libs.androidx.room.compiler
    androidTestImplementation libs.androidx.room.test

    implementation libs.materialdialogs.input
    implementation libs.materialdialogs.core
    implementation libs.materialdialogs.bottomSheets
    implementation libs.materialdialogs.color

    implementation libs.firebase.ui.auth
    implementation libs.firebase.ui.firestore
    implementation libs.firebase.ui.storage

    kapt libs.glide.compiler

    implementation libs.google.ossLic
    implementation libs.google.material
    implementation libs.google.ads
    implementation libs.bundles.firebase

    implementation 'com.google.android.play:core:1.10.3'
    implementation libs.google.gson

    implementation libs.commonsIo
    compileOnly files("libs/api-82.jar")

    implementation libs.hilt.hilt
    kapt libs.hilt.compiler

    implementation libs.epoxy.epoxy
    kapt libs.epoxy.processor

    implementation libs.kotlin.coroutines.core
    implementation libs.kotlin.coroutines.android
    implementation libs.kotlin.coroutines.play
    testImplementation libs.kotlin.coroutines.test

    testImplementation libs.test.junit
    androidTestImplementation libs.androidx.test.junitExt
    androidTestImplementation libs.androidx.test.espresso

    testImplementation libs.androidx.test.core

    implementation libs.okhttp.okhttp
    implementation 'me.zhanghai.android.fastscroll:library:1.1.8'
}
